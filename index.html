<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的摄影网站</title>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "微软雅黑", sans-serif;
        }

        /* 密码页面样式 */
        .password-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .password-title {
            font-size: 24px;
            margin-bottom: 20px;
            cursor: pointer; /* 提示“请”字可点击 */
        }
        .password-input {
            padding: 10px;
            font-size: 18px;
            margin: 10px 0;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .submit-btn {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .error-msg {
            color: red;
            margin-top: 10px;
            display: none;
        }

        /* 私密空间密码框（默认隐藏） */
        .secret-password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .secret-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        /* 摄影页面样式 */
        .gallery-container {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .gallery-title {
            font-size: 32px;
        }
        /* 上传按钮样式 */
        .upload-section {
            position: relative;
        }
        .upload-btn {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .upload-btn:hover {
            background-color: #1976D2;
        }
        .upload-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .photo-item {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            position: relative; /* 为删除按钮定位 */
        }
        .photo-item:hover {
            transform: translateY(-5px);
        }
        .photo-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        .photo-desc {
            padding: 10px;
            text-align: center;
            background-color: white;
        }
        /* 删除按钮样式 */
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .photo-item:hover .delete-btn {
            opacity: 1; /* hover时显示删除按钮 */
        }
        .delete-btn:hover {
            background-color: red;
        }

        /* 私密空间页面样式 */
        .secret-container {
            display: none;
            height: 100vh;
            background: #222;
            color: white;
            padding: 40px;
            text-align: center;
        }
        .secret-title {
            font-size: 36px;
            margin-bottom: 30px;
        }
        .secret-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }
        /* 返回按钮样式 */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 16px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .back-btn:hover {
            background-color: #888;
        }
    </style>
</head>
<body>
    <!-- 主密码输入界面 -->
    <div class="password-container">
        <h2 class="password-title">
            <span class="secret-trigger">请</span>输入访问密码
        </h2>
        <input type="password" class="password-input" placeholder="输入密码">
        <button class="submit-btn">进入</button>
        <div class="error-msg">密码错误，请重试</div>
    </div>

    <!-- 私密空间密码弹窗（隐藏） -->
    <div class="secret-password-modal">
        <div class="secret-modal-content">
            <h3>请输入私密空间密码</h3>
            <input type="password" class="secret-password-input" placeholder="输入私密密码" style="margin:15px 0;">
            <button class="secret-submit-btn">确认</button>
            <div class="secret-error-msg" style="color:red;display:none;margin-top:10px;">密码错误</div>
        </div>
    </div>

    <!-- 摄影作品展示页面（含上传+删除功能） -->
    <div class="gallery-container">
        <div class="gallery-header">
            <h1 class="gallery-title">我的摄影作品</h1>
            <div class="upload-section">
                <button class="upload-btn">上传新作品</button>
                <input type="file" class="upload-input" accept="image/*" multiple>
            </div>
        </div>
        <div class="photo-grid" id="photoGrid">
            <!-- 初始示例作品（添加data-url属性用于删除） -->
            <div class="photo-item" data-url="https://picsum.photos/id/1015/600/400">
                <button class="delete-btn" onclick="deletePhoto(this)">×</button>
                <img src="https://picsum.photos/id/1015/600/400" alt="自然风光">
                <div class="photo-desc">山间溪流 · 2024.05</div>
            </div>
            <div class="photo-item" data-url="https://picsum.photos/id/1025/600/400">
                <button class="delete-btn" onclick="deletePhoto(this)">×</button>
                <img src="https://picsum.photos/id/1025/600/400" alt="城市夜景">
                <div class="photo-desc">城市霓虹 · 2024.08</div>
            </div>
            <div class="photo-item" data-url="https://picsum.photos/id/1035/600/400">
                <button class="delete-btn" onclick="deletePhoto(this)">×</button>
                <img src="https://picsum.photos/id/1035/600/400" alt="人文纪实">
                <div class="photo-desc">街头瞬间 · 2024.09</div>
            </div>
            <div class="photo-item" data-url="https://picsum.photos/id/1043/600/400">
                <button class="delete-btn" onclick="deletePhoto(this)">×</button>
                <img src="https://picsum.photos/id/1043/600/400" alt="静物特写">
                <div class="photo-desc">咖啡时光 · 2024.10</div>
            </div>
        </div>
    </div>

    <!-- 私密空间页面 -->
    <div class="secret-container">
        <button class="back-btn">返回主界面</button>
        <h1 class="secret-title">私密空间</h1>
        <div class="secret-content">
            <p>这里可以放置仅自己可见的内容：</p>
            <p>比如未公开的摄影作品、私人笔记等</p>
            <img src="https://picsum.photos/id/1074/800/400" alt="私密作品" style="margin:20px auto;max-width:100%;border-radius:8px;">
        </div>
    </div>

    <script>
        // 【必须替换！】你的GitHub配置（否则无法加载/保存照片）
        const IMGBB_API_KEY = '4340e149852177b4f1902b99c0b46049';
        const GITHUB_TOKEN = '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';
        const GITHUB_USERNAME = 'LucasWhoUseCanon'; // 例：test123（替换成你的账号名）
        const GITHUB_REPO = 'LucasWhoUseCanon.github.io'; // 例：test123.github.io（替换成你的仓库名）
        const PHOTO_FILE_PATH = 'photos.json'; // 存储照片数据的文件（无需修改）

        // 元素获取
        const passwordInput = document.querySelector('.password-input');
        const submitBtn = document.querySelector('.submit-btn');
        const errorMsg = document.querySelector('.error-msg');
        const passwordContainer = document.querySelector('.password-container');
        const galleryContainer = document.querySelector('.gallery-container');
        const secretTrigger = document.querySelector('.secret-trigger');
        const secretModal = document.querySelector('.secret-password-modal');
        const secretPasswordInput = document.querySelector('.secret-password-input');
        const secretSubmitBtn = document.querySelector('.secret-submit-btn');
        const secretErrorMsg = document.querySelector('.secret-error-msg');
        const secretContainer = document.querySelector('.secret-container');
        const backBtn = document.querySelector('.back-btn');
        const uploadInput = document.querySelector('.upload-input');
        const photoGrid = document.getElementById('photoGrid');

        // 页面加载时强制加载所有照片（修复刷新不显示问题）
        window.addEventListener('load', () => {
            setTimeout(loadPhotosFromGitHub, 500); // 延迟加载，确保DOM渲染完成
        });

        // 1. 私密空间触发：连续点击“请”字3次
        let clickCount = 0;
        secretTrigger.addEventListener('click', () => {
            clickCount++;
            if (clickCount === 3) {
                secretModal.style.display = 'flex';
                clickCount = 0;
            }
        });

        // 2. 主密码验证（0905）
        submitBtn.addEventListener('click', () => {
            const inputPassword = passwordInput.value.trim();
            if (inputPassword === '0905') {
                passwordContainer.style.display = 'none';
                galleryContainer.style.display = 'block';
            } else {
                errorMsg.style.display = 'block';
                passwordInput.value = '';
            }
        });

        // 3. 私密空间密码验证（0613）
        secretSubmitBtn.addEventListener('click', () => {
            const secretInput = secretPasswordInput.value.trim();
            if (secretInput === '0613') {
                secretModal.style.display = 'none';
                passwordContainer.style.display = 'none';
                secretContainer.style.display = 'block';
            } else {
                secretErrorMsg.style.display = 'block';
                secretPasswordInput.value = '';
            }
        });

        // 4. 返回按钮逻辑
        backBtn.addEventListener('click', () => {
            secretContainer.style.display = 'none';
            passwordContainer.style.display = 'flex';
            passwordInput.value = '';
            secretPasswordInput.value = '';
        });

        // 5. 图片上传功能（修复保存逻辑，确保写入GitHub）
        uploadInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length === 0) return;

            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    alert('请上传图片文件！');
                    continue;
                }

                const formData = new FormData();
                formData.append('image', file);
                formData.append('key', IMGBB_API_KEY);

                // 调用ImgBB API上传
                fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('上传到ImgBB失败');
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const imgUrl = data.data.url;
                        const now = new Date();
                        const dateStr = `${now.getFullYear()}.${now.getMonth() + 1}`;

                        // 前端渲染+写入GitHub（同步执行）
                        renderPhotoItem(imgUrl, dateStr);
                        saveToGitHub(imgUrl, dateStr)
                            .then(() => alert('上传成功！刷新页面不会丢失'))
                            .catch(err => {
                                alert('图片上传成功，但保存到GitHub失败：' + err.message);
                                console.error(err);
                            });
                    } else {
                        alert('上传失败：' + data.error.message);
                    }
                })
                .catch(error => {
                    alert('网络错误，上传失败：' + error.message);
                    console.error(error);
                });
            }
            uploadInput.value = '';
        });

        // 6. 渲染照片项（添加data-url属性，用于删除识别）
        function renderPhotoItem(imgUrl, desc) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.setAttribute('data-url', imgUrl); // 存储图片URL，用于删除
            photoItem.innerHTML = `
                <button class="delete-btn" onclick="deletePhoto(this)">×</button>
                <img src="${imgUrl}" alt="摄影作品">
                <div class="photo-desc">${desc}</div>
            `;
            photoGrid.appendChild(photoItem);
        }

        // 7. 保存图片到GitHub（优化错误处理，确保文件生成）
        async function saveToGitHub(imgUrl, desc) {
            try {
                // 步骤1：获取现有文件（不存在则创建）
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PHOTO_FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let existingData = { content: '', sha: '' };
                if (getRes.status === 200) {
                    existingData = await getRes.json();
                } else if (getRes.status !== 404) {
                    throw new Error('获取GitHub文件失败');
                }

                // 步骤2：解析并添加新照片
                const existingPhotos = existingData.content
                    ? JSON.parse(atob(existingData.content))
                    : [];
                existingPhotos.push({
                    url: imgUrl,
                    desc: desc,
                    time: new Date().toISOString()
                });

                // 步骤3：提交到GitHub
                const putRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PHOTO_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add new photo: ${desc}`,
                        content: btoa(JSON.stringify(existingPhotos)),
                        sha: existingData.sha
                    })
                });

                if (!putRes.ok) throw new Error('提交到GitHub失败');
            } catch (err) {
                throw err;
            }
        }

        // 8. 从GitHub加载所有照片（修复刷新不显示问题）
        async function loadPhotosFromGitHub() {
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PHOTO_FILE_PATH}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (res.status === 404) return; // 无保存的照片
                const data = await res.json();
                const photos = JSON.parse(atob(data.content));

                // 清空现有示例，重新渲染所有照片
                photoGrid.innerHTML = '';
                photos.forEach(photo => {
                    renderPhotoItem(photo.url, photo.desc);
                });
            } catch (err) {
                console.error('加载照片失败：', err);
            }
        }

        // 9. 删除照片功能（前端+GitHub同步删除）
        window.deletePhoto = async function(btn) {
            const photoItem = btn.closest('.photo-item');
            const imgUrl = photoItem.getAttribute('data-url');
            if (!confirm('确定要删除这张照片吗？')) return;

            try {
                // 步骤1：删除前端DOM
                photoItem.remove();

                // 步骤2：从GitHub中删除对应的照片
                const getRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PHOTO_FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getRes.ok) throw new Error('获取照片列表失败');
                const existingData = await getRes.json();
                const existingPhotos = JSON.parse(atob(existingData.content));

                // 过滤掉要删除的照片
                const newPhotos = existingPhotos.filter(photo => photo.url !== imgUrl);

                // 提交更新后的列表到GitHub
                const putRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PHOTO_FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Delete photo',
                        content: btoa(JSON.stringify(newPhotos)),
                        sha: existingData.sha
                    })
                });

                if (!putRes.ok) throw new Error('删除GitHub中的照片失败');
                alert('照片删除成功！');
            } catch (err) {
                alert('删除失败：' + err.message);
                console.error(err);
            }
        }

        // 10. 回车键支持
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') submitBtn.click();
        });
        secretPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') secretSubmitBtn.click();
        });
    </script>
</body>
</html>
